#!/bin/sh

DEV=/dev/$MDEV
MNT=/mnt/usb/$MDEV

LOGGER='/usr/bin/logger -t hotplug'
TARGET=$(cat /etc/platform).pkg
SCRIPT=command.sh

set_led() {
  if [ $2 != 0 ]; then
    /bin/echo timer > /sys/class/leds/status/trigger
    /bin/echo $2 > /sys/class/leds/status/delay_on
    /bin/echo $2 > /sys/class/leds/status/delay_off
  else
    /bin/echo none > /sys/class/leds/status/trigger
  fi
  /bin/echo $1 > /sys/class/leds/status/brightness
}

device_plug() {
  echo $DEV | $LOGGER

  # Set LED to a fast blink
  set_led 1 100

  # Create a mount point for this volume
  if [ ! -d $MNT ]; then
    mkdir -p $MNT
  fi

  # Make sure the mount path isn't already mounted
  if grep $MNT /proc/mounts 1> /dev/null ; then
    echo "Cannot mount $DEV, mount point already mounted!" | $LOGGER
    set_led 0 0
    return 1
  fi

  # Pause briefly for the mount device to appear
  /bin/sleep 1

  # mount the device
  if ! /bin/mount -o ro $DEV $MNT ; then
    echo "Failed to mount $DEV" | $LOGGER
    set_led 0 0
    return 1
  fi

  # If there is a script on the device, execute it
  if [ -f $MNT/$SCRIPT ]; then
    # Set led to slow blink for processing
	set_led 1 250

    # Artificial delay so the user can see it blink
    /bin/sleep 3

    echo "Running $SCRIPT from USB device $DEV mounted at $MNT" | $LOGGER
    if ! /bin/sh $MNT/$SCRIPT | $LOGGER; then
      set_led 0 0
    else
      set_led 1 0
    fi
  fi

  # if there is a file on the device, execute it
  if [ -f $MNT/$TARGET ]; then
    # Set led to slow blink for processing
	set_led 1 250

    # Artificial delay so the user can see it blink
    /bin/sleep 3

    echo "Running $TARGET from USB device $DEV mounted at $MNT" | $LOGGER
    if ! /usr/sbin/pkgtool -i $MNT/$TARGET | $LOGGER ; then
      set_led 0 0
    else
      set_led 1 0
    fi
  fi

  # unmount the USB stick ( not strictly necessary )
  echo "Unmounting $DEV" | $LOGGER
  /bin/umount $MNT
}

device_remove() {
  # Blindly set the sys LED to solid green
  $LOGGER "Unplug"
  set_led 1 0
}

$LOGGER $ACTION

case "$ACTION" in
  add)
    if echo "$DEV" | grep sd[a-z][0-9] > /dev/null; then
      device_plug
    else
      echo "$DEV does not look like a partition, nothing to do" | $LOGGER
    fi
    ;;
  remove)
    device_remove
    ;;
  *)
    ;;
esac
