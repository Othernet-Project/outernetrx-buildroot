#!/bin/sh

MTD=/dev/$(grep \"data\" /proc/mtd | cut -d : -f 1)

mount_start() {
  # Bail if no UBI volume
  [ -c /dev/ubi0 ] || exit 1

  # Mount the persist volume
  if ! grep /mnt/persist /proc/mounts 1> /dev/null ; then

    # Create the persist volume if it does not exist
    if ! /usr/sbin/ubinfo -d 0 -N persist 1> /dev/null 2>&1 ; then
      /usr/sbin/ubimkvol /dev/ubi0 -N persist -s 32MiB || exit 1
    fi

    /bin/echo "Mounting ubi0:persist on /mnt/persist"
    /bin/mkdir /mnt/persist
    /bin/mount -o noatime -t ubifs ubi0:persist /mnt/persist || exit 1
    /bin/chmod 2775 /mnt/persist
    /bin/chgrp config /mnt/persist
  fi

  # Mount the data volume
  if ! grep /mnt/data /proc/mounts 1> /dev/null ; then
    /bin/mkdir /mnt/data

    # Create the data volume if it does not exist
    if ! /usr/sbin/ubinfo -d 0 -N data 1> /dev/null 2>&1 ; then
      /usr/sbin/ubimkvol /dev/ubi0 -N data -s 3584MiB || exit 1
    fi
    /bin/echo "Mounting ubi0:data on /mnt/data"
    /bin/mount -o noatime -t ubifs ubi0:data /mnt/data

    /bin/chmod 2775 /mnt/data
    /bin/chgrp data /mnt/data
  fi
}

mount_stop() {
  if grep /mnt/data /proc/mounts 1> /dev/null ; then
    /bin/echo "Unmounting /mnt/data"
    /bin/umount -f /mnt/data
  fi
  if grep /mnt/persist /proc/mounts 1> /dev/null ; then
    /bin/echo "Unmounting /mnt/persist"
    /bin/umount -f /mnt/persist
  fi

  if [ -c /dev/ubi0 ]; then
    /usr/sbin/ubidetach -p $MTD
  fi
}

case "$1" in
  start)
    mount_start
    ;;
  stop)
    mount_stop
    ;;
  restart|reload)
    ;;
  *)
    echo -n "usage: $0 {start|stop|restart|reload}"
    ;;
esac
